@using WSClient.ApplicationWS
@using WSUseExpenseManagerClient
@{
	ViewData["Title"] = "Index";
}

<h2>Agregar Usuario al Grupo</h2>
<div id="liveAlertPlaceholder"></div>
<form id="userGroupForm">
	<div class="form-group">
		<label for="idGroup">Seleccionar un Grupo:</label>
		<select id="idGroup" name="idGroup" class="form-select" aria-label="Default select example">
			<option value="">Seleccione </option>
			@foreach (GroupDTO group in Model.groupDTOs)
			{
				<option value="@group.Id">@group.Name</option>
			}
		</select>
	</div>
	<div class="form-group">
		<label for="idUser">Buscar un Usuario:</label>
		<select id="idUser" name="idUser" class="form-select" aria-label="Default select example">
			<option value="">Seleccione </option>
			@foreach (UserDTO user in Model.userDTOs)
			{
				<option value="@user.Id">@user.Name</option>
			}
		</select>
	</div>

	<div class="form-group">
		<button type="button" id="userGroupButton"
				name="userGroupButton" class="btn btn-primary">
			Agregar Usuario
		</button>
	</div>
</form>

<table class="table table-striped" id="userGroupTable">
	<thead>
		<tr>
			<th>Código</th>
			<th>Name Usuario</th>
			<th>Name Grupo</th>
			@* <th>Acciones</th> *@
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<form id="saveGroupUserForm">
	<div class="form-group">
		<button type="button" id="saveGroupUser" class="btn btn-primary">Guardar Todos</button>
	</div>
</form>
<script type="text/javascript">
	//Add new User-Group
	document.getElementById("userGroupButton").addEventListener("click", function () {
		updateUserGroup();
	});
	function updateUserGroup() {
		var idGroup = document.getElementById("idGroup").value;
		var idUser = document.getElementById("idUser").value;

		var formData = new FormData();
		//formData.append("idGroup", idGroup);
		formData.append("idUser", idUser);

		fetch('/Group/AddUserToGroup', {
			method: 'POST',
			body: formData
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('Error en la solicitud');
				}
				return response.json();
			})
			.then(data => {
				console.log(data);
				actualizarTabla(data);
			})
			.catch(error => {
				console.error('Error en la solicitud:', error);
			});
	}
	//Save To new Group with User
	document.getElementById("saveGroupUserForm").addEventListener("click", function () {
		saveUserGroup();
	});
	function saveUserGroup() {
		var idGroup = document.getElementById("idGroup").value;

		var formData = new FormData();
		formData.append("idGroup", idGroup);

		fetch('/Group/saveGroupUserForm', {
			method: 'POST',
			body: formData
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('Error en la solicitud');
				}
				return response.json();
			})
			.then(data => {
				console.log(data);

				var jsonString = JSON.stringify(data);

				showAlertMessage("La operación con ID " + jsonString + " fue ejecutada exitosamente.");
				var tbody = document.getElementById("userGroupTable").getElementsByTagName("tbody")[0];
				tbody.innerHTML = "";
				//actualizarTabla(data);
			})
			.catch(error => {
				console.error('Error en la solicitud:', error);
			});
	}

	function actualizarTabla(data) {
		var tabla = document.getElementById("userGroupTable").getElementsByTagName("tbody")[0];;

		tabla.innerHTML = "";

		data.forEach(function (groupUser) {
			var fila = tabla.insertRow();

			var celdaId = fila.insertCell();
			celdaId.innerHTML = groupUser.id;

			var celdaNombreGrupo = fila.insertCell();
			celdaNombreGrupo.innerHTML = groupUser.name;

			var celdaNombreUsuario = fila.insertCell();
			celdaNombreUsuario.innerHTML = groupUser.fullNameGroup;

		});
	}

	function showAlertMessage(message) {
		var alertDiv = document.createElement("div");
		alertDiv.classList.add("alert", "alert-success");
		alertDiv.textContent = message;

		var placeholderDiv = document.getElementById("liveAlertPlaceholder");

		placeholderDiv.appendChild(alertDiv);

		setTimeout(function () {
			alertDiv.classList.add("fade");
			setTimeout(function () {
				alertDiv.remove();
			}, 1000);
		}, 5000); 
	}

</script>


